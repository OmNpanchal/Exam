name: Deploy to IIS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout source code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Deploy to IIS using RoboCopy (recommended)
      - name: Deploy to IIS wwwroot
        shell: powershell
        run: |
          $source = "$env:GITHUB_WORKSPACE"
          $target = "C:\inetpub\wwwroot"

          Write-Host "Deploying from $source to $target"

          # Ensure target exists
          if (!(Test-Path $target)) {
            New-Item -ItemType Directory -Path $target | Out-Null
          }

          # RoboCopy mirrors content and excludes GitHub/system folders
          robocopy `
            $source `
            $target `
            /MIR `
            /XD ".git" ".github" `
            /XF ".gitignore" "README.md" `
            /R:2 `
            /W:5 `
            /NFL `
            /NDL `
            /NP

          # RoboCopy returns exit codes 0–7 for success
          if ($LASTEXITCODE -gt 7) {
            Write-Error "Deployment failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "Deployment completed successfully"
